{{define "users-list-page"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - USL Management</title>
    
    <!-- Tailwind CSS -->
    <link href="/static/dist/output.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="/static/htmx.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    {{template "navigation" .}}
    
    <main class="container mx-auto px-4 py-8">
<div class="flex justify-between items-start mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Users</h1>
        <p class="mt-2 text-gray-600">Manage league members and their information</p>
    </div>
    
    <a href="/usl/users/new" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md font-semibold transition-all duration-200" style="background-color: #2563eb !important; color: white !important; padding: 0.5rem 1rem !important;">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
        Add User
    </a>
</div>

{{template "search-form" .SearchConfig}}

<!-- Filters and Sorting Controls -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- TrueSkill Range Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">TrueSkill μ Range</label>
            <div class="flex space-x-2">
                <input type="number" id="trueskill-min" placeholder="Min" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
                <input type="number" id="trueskill-max" placeholder="Max" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- Status Filter -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="banned">Banned</option>
            </select>
        </div>
        
        <!-- Clear Filters -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
            <button onclick="clearAllFilters()" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium transition-colors">
                Clear All
            </button>
        </div>
    </div>
</div>

<!-- Users Table -->
<div id="users-table" class="bg-white shadow overflow-x-auto sm:rounded-lg p-6">
    <table class="w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" 
                    onclick="sortTable('name')">
                    <div class="flex items-center">
                        Name
                        <svg class="ml-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                </th>
                <th scope="col" class="w-32 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" 
                    onclick="sortTable('trueskill')">
                    <div class="flex items-center justify-center">
                        TrueSkill μ
                        <svg class="ml-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                </th>
                <th scope="col" class="w-32 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" 
                    onclick="sortTable('status')">
                    <div class="flex items-center justify-center">
                        Status
                        <svg class="ml-2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody id="users-tbody" class="bg-white divide-y divide-gray-200">
            {{range .Users}}
            <tr data-trueskill="{{.TrueSkillMu}}" data-name="{{.Name}}" data-status="{{if .Banned}}banned{{else if .Active}}active{{else}}inactive{{end}}" class="hover:bg-gray-50 cursor-pointer transition-colors" onclick="window.location.href='/usl/users/detail?id={{.ID}}'">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                <span class="text-sm font-medium text-gray-700">{{substr .Name 0 1}}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">{{.Name}}</div>
                            <div class="text-sm text-gray-500">{{.DiscordID}}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-blue-600">{{printf "%.3f" .TrueSkillMu}}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{if .Active}}bg-green-100 text-green-800{{else}}bg-red-100 text-red-800{{end}}">
                            {{if .Active}}Active{{else}}Inactive{{end}}
                        </span>
                        {{if .Banned}}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            Banned
                        </span>
                        {{end}}
                    </div>
                </td>
            </tr>
            {{else}}
            <tr>
                <td colspan="3" class="px-6 py-8 text-center text-gray-500">
                    No users found.
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>
    </main>
    
    <!-- HTMX Configuration -->
    <script>
        document.body.addEventListener('htmx:responseError', function(evt) {
            if (evt.detail.xhr.status === 500) {
                alert('Server error occurred. Please try again.');
            }
        });
        
        // Table sorting and filtering functionality
        window.userListState = window.userListState || {
            currentSort: { column: 'name', direction: 'asc' },
            allRows: []
        };
        
        // Initialize table functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Store all rows for filtering
            const tbody = document.getElementById('users-tbody');
            if (tbody) {
                window.userListState.allRows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.querySelector('td'));
            }
            
            // Set up filter event listeners
            setupFilterListeners();
            
            // Apply initial sort
            applySorting();
        });
        
        function setupFilterListeners() {
            // TrueSkill range filters
            const trueskillMin = document.getElementById('trueskill-min');
            const trueskillMax = document.getElementById('trueskill-max');
            const statusFilter = document.getElementById('status-filter');
            
            if (trueskillMin) {
                trueskillMin.addEventListener('input', debounce(applyFilters, 300));
            }
            if (trueskillMax) {
                trueskillMax.addEventListener('input', debounce(applyFilters, 300));
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function sortTable(column) {
            // Toggle direction if clicking same column
            if (window.userListState.currentSort.column === column) {
                window.userListState.currentSort.direction = window.userListState.currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                window.userListState.currentSort.column = column;
                window.userListState.currentSort.direction = 'asc';
            }
            
            applySorting();
        }
        
        function applySorting() {
            const tbody = document.getElementById('users-tbody');
            if (!tbody || window.userListState.allRows.length === 0) return;
            
            const sortedRows = [...window.userListState.allRows].sort((a, b) => {
                let aValue, bValue;
                
                switch (window.userListState.currentSort.column) {
                    case 'name':
                        aValue = a.dataset.name?.toLowerCase() || '';
                        bValue = b.dataset.name?.toLowerCase() || '';
                        break;
                    case 'trueskill':
                        aValue = parseFloat(a.dataset.trueskill) || 0;
                        bValue = parseFloat(b.dataset.trueskill) || 0;
                        break;
                    case 'status':
                        aValue = a.dataset.status || '';
                        bValue = b.dataset.status || '';
                        break;
                    default:
                        return 0;
                }
                
                let result;
                if (typeof aValue === 'string') {
                    result = aValue.localeCompare(bValue);
                } else {
                    result = aValue - bValue;
                }
                
                return window.userListState.currentSort.direction === 'desc' ? -result : result;
            });
            
            // Re-populate tbody with sorted rows
            tbody.innerHTML = '';
            sortedRows.forEach(row => tbody.appendChild(row));
            
            // Apply filters after sorting
            applyFilters();
        }
        
        function applyFilters() {
            const trueskillMin = parseFloat(document.getElementById('trueskill-min')?.value) || null;
            const trueskillMax = parseFloat(document.getElementById('trueskill-max')?.value) || null;
            const statusFilter = document.getElementById('status-filter')?.value || '';
            
            const tbody = document.getElementById('users-tbody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (!row.dataset.trueskill) {
                    // This is the "no users found" row - handle separately
                    return;
                }
                
                let shouldShow = true;
                
                // TrueSkill range filter
                const trueskill = parseFloat(row.dataset.trueskill);
                if (trueskillMin !== null && trueskill < trueskillMin) {
                    shouldShow = false;
                }
                if (trueskillMax !== null && trueskill > trueskillMax) {
                    shouldShow = false;
                }
                
                // Status filter
                if (statusFilter && row.dataset.status !== statusFilter) {
                    shouldShow = false;
                }
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Show/hide "no users found" message
            const noUsersRow = tbody.querySelector('tr:not([data-trueskill])');
            if (noUsersRow) {
                noUsersRow.style.display = visibleCount === 0 ? '' : 'none';
            }
        }
        
        function clearAllFilters() {
            // Clear filter inputs
            const trueskillMin = document.getElementById('trueskill-min');
            const trueskillMax = document.getElementById('trueskill-max');
            const statusFilter = document.getElementById('status-filter');
            
            if (trueskillMin) trueskillMin.value = '';
            if (trueskillMax) trueskillMax.value = '';
            if (statusFilter) statusFilter.value = '';
            
            // Reset sort
            window.userListState.currentSort = { column: 'name', direction: 'asc' };
            
            // Reapply sorting and show all rows
            applySorting();
        }
    </script>
</body>
</html>
{{end}}